record(bo, "$(P)$(R)Control:Disconnect")
{
    field(DESC, "Disconnects from the RTDE interface")
    field(DTYP, "asynInt32")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))DISCONNECT")
}

record(bo, "$(P)$(R)Control:Reconnect")
{
    field(DESC, "Tries reconnecting to the RTDE interface")
    field(DTYP, "asynInt32")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))RECONNECT")
}

record(bi, "$(P)$(R)Control:Connected")
{
    field(DESC, "RTDE Connection status")
    field(DTYP, "asynInt32")
    field(INP,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))IS_CONNECTED")
    field(SCAN, "I/O Intr")
}

record(bi, "$(P)$(R)Control:Steady")
{
    field(DESC, "Is robot fully at rest")
    field(DTYP, "asynInt32")
    field(INP,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))IS_STEADY")
    field(SCAN, "I/O Intr")
}

record(bo, "$(P)$(R)Control:moveJ")
{
    field(DESC, "Moves joints to commanded values")
    field(DTYP, "asynInt32")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))MOVEJ")
}


#======================
# Joint control
#======================

# current joint positions for use interally with this database
record(waveform, "$(P)$(R)Control:ActualQ")
{
    field(DESC, "Actual joint positions")     
    field(DTYP, "asynFloat64ArrayIn")
    field(FTVL, "DOUBLE")
    field(INP,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))ACTUAL_Q")
    field(NELM, 6)
    field(FLNK, "$(P)$(R)Q_index_fanout.PROC")
    field(SCAN, "I/O Intr")
}

record(fanout, "$(P)$(R)Q_index_fanout")
{
    field(LNK0, "$(P)$(R)Control:ActualQ_index0")
    field(LNK1, "$(P)$(R)Control:ActualQ_index1")
    field(LNK2, "$(P)$(R)Control:ActualQ_index2")
    field(LNK3, "$(P)$(R)Control:ActualQ_index3")
    field(LNK4, "$(P)$(R)Control:ActualQ_index4")
    field(LNK5, "$(P)$(R)Control:ActualQ_index5")
}

# subArray to extract each element of ActualQ waveform
record(subArray, "$(P)$(R)Control:ActualQ_index0")
{
    field(INP, "$(P)$(R)Control:ActualQ.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "0")
}
record(subArray, "$(P)$(R)Control:ActualQ_index1")
{
    field(INP, "$(P)$(R)Control:ActualQ.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "1")
}
record(subArray, "$(P)$(R)Control:ActualQ_index2")
{
    field(INP, "$(P)$(R)Control:ActualQ.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "2")
}
record(subArray, "$(P)$(R)Control:ActualQ_index3")
{
    field(INP, "$(P)$(R)Control:ActualQ.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "3")
}
record(subArray, "$(P)$(R)Control:ActualQ_index4")
{
    field(INP, "$(P)$(R)Control:ActualQ.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "4")
}
record(subArray, "$(P)$(R)Control:ActualQ_index5")
{
    field(INP, "$(P)$(R)Control:ActualQ.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "5")
}

# stores DOLx.VAL in LNKx.VAL
# resets commanded joint angles to the current measured angles
record(seq, "$(P)Control:ResetJCmd")
{
    field(DOL0, "$(P)$(R)Control:ActualQ_index0")
    field(LNK0, "$(P)$(R)Control:J1Cmd PP")

    field(DOL1, "$(P)$(R)Control:ActualQ_index1")
    field(LNK1, "$(P)$(R)Control:J2Cmd PP")

    field(DOL2, "$(P)$(R)Control:ActualQ_index2")
    field(LNK2, "$(P)$(R)Control:J3Cmd PP")

    field(DOL3, "$(P)$(R)Control:ActualQ_index3")
    field(LNK3, "$(P)$(R)Control:J4Cmd PP")
    
    field(DOL4, "$(P)$(R)Control:ActualQ_index4")
    field(LNK4, "$(P)$(R)Control:J5Cmd PP")

    field(DOL5, "$(P)$(R)Control:ActualQ_index5")
    field(LNK5, "$(P)$(R)Control:J6Cmd PP")
}

# -----------------------------------------------------------

record(ao, "$(P)$(R)Control:J1Cmd")
{
    field(DESC, "Commanded angle(deg) for joint 1")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))J1CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:J1TweakVal")
{
    field(DESC, "Joint 1 tweak step size")
    field(EGU, "degrees")
}

record(bo, "$(P)$(R)Control:J1TweakFwd")
{
    field(DESC, "Tweak joint 1 forward")
    field(FLNK, "$(P)$(R)Control:J1TweakCalcFwd.PROC")
}

record(bo, "$(P)$(R)Control:J1TweakRev")
{
    field(DESC, "Tweak joint 1 backward")
    field(FLNK, "$(P)$(R)Control:J1TweakCalcRev.PROC")
}

record(calcout, "$(P)$(R)Control:J1TweakCalcFwd")
{
    field(INPA, "$(P)$(R)Control:J1Cmd")
    field(INPB, "$(P)$(R)Control:J1TweakVal")
    field(CALC, "A + B")
    field(OUT, "$(P)$(R)Control:J1Cmd PP")
}

record(calcout, "$(P)$(R)Control:J1TweakCalcRev")
{
    field(INPA, "$(P)$(R)Control:J1Cmd")
    field(INPB, "$(P)$(R)Control:J1TweakVal")
    field(CALC, "A - B")
    field(OUT, "$(P)$(R)Control:J1Cmd PP")
}

# -----------------------------------------------------------

record(ao, "$(P)$(R)Control:J2Cmd")
{
    field(DESC, "Commanded angle(deg) for joint 2")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))J2CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:J2TweakVal")
{
    field(DESC, "Joint 2 tweak step size")
    field(EGU, "degrees")
}

record(bo, "$(P)$(R)Control:J2TweakFwd")
{
    field(DESC, "Tweak joint 2 forward")
    field(FLNK, "$(P)$(R)Control:J2TweakCalcFwd.PROC")
}

record(bo, "$(P)$(R)Control:J2TweakRev")
{
    field(DESC, "Tweak joint 2 backward")
    field(FLNK, "$(P)$(R)Control:J2TweakCalcRev.PROC")
}

record(calcout, "$(P)$(R)Control:J2TweakCalcFwd")
{
    field(INPA, "$(P)$(R)Control:J2Cmd")
    field(INPB, "$(P)$(R)Control:J2TweakVal")
    field(CALC, "A + B")
    field(OUT, "$(P)$(R)Control:J2Cmd PP")
}

record(calcout, "$(P)$(R)Control:J2TweakCalcRev")
{
    field(INPA, "$(P)$(R)Control:J2Cmd")
    field(INPB, "$(P)$(R)Control:J2TweakVal")
    field(CALC, "A - B")
    field(OUT, "$(P)$(R)Control:J2Cmd PP")
}

# -----------------------------------------------------------

record(ao, "$(P)$(R)Control:J3Cmd")
{
    field(DESC, "Commanded angle(deg) for joint 3")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))J3CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:J3TweakVal")
{
    field(DESC, "Joint 3 tweak step size")
    field(EGU, "degrees")
}

record(bo, "$(P)$(R)Control:J3TweakFwd")
{
    field(DESC, "Tweak joint 3 forward")
    field(FLNK, "$(P)$(R)Control:J3TweakCalcFwd.PROC")
}

record(bo, "$(P)$(R)Control:J3TweakRev")
{
    field(DESC, "Tweak joint 3 backward")
    field(FLNK, "$(P)$(R)Control:J3TweakCalcRev.PROC")
}

record(calcout, "$(P)$(R)Control:J3TweakCalcFwd")
{
    field(INPA, "$(P)$(R)Control:J3Cmd")
    field(INPB, "$(P)$(R)Control:J3TweakVal")
    field(CALC, "A + B")
    field(OUT, "$(P)$(R)Control:J3Cmd PP")
}

record(calcout, "$(P)$(R)Control:J3TweakCalcRev")
{
    field(INPA, "$(P)$(R)Control:J3Cmd")
    field(INPB, "$(P)$(R)Control:J3TweakVal")
    field(CALC, "A - B")
    field(OUT, "$(P)$(R)Control:J3Cmd PP")
}

# -----------------------------------------------------------

record(ao, "$(P)$(R)Control:J4Cmd")
{
    field(DESC, "Commanded angle(deg) for joint 4")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))J4CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:J4TweakVal")
{
    field(DESC, "Joint 4 tweak step size")
    field(EGU, "degrees")
}

record(bo, "$(P)$(R)Control:J4TweakFwd")
{
    field(DESC, "Tweak joint 4 forward")
    field(FLNK, "$(P)$(R)Control:J4TweakCalcFwd.PROC")
}

record(bo, "$(P)$(R)Control:J4TweakRev")
{
    field(DESC, "Tweak joint 4 backward")
    field(FLNK, "$(P)$(R)Control:J4TweakCalcRev.PROC")
}

record(calcout, "$(P)$(R)Control:J4TweakCalcFwd")
{
    field(INPA, "$(P)$(R)Control:J4Cmd")
    field(INPB, "$(P)$(R)Control:J4TweakVal")
    field(CALC, "A + B")
    field(OUT, "$(P)$(R)Control:J4Cmd PP")
}

record(calcout, "$(P)$(R)Control:J4TweakCalcRev")
{
    field(INPA, "$(P)$(R)Control:J4Cmd")
    field(INPB, "$(P)$(R)Control:J4TweakVal")
    field(CALC, "A - B")
    field(OUT, "$(P)$(R)Control:J4Cmd PP")
}
# -----------------------------------------------------------

record(ao, "$(P)$(R)Control:J5Cmd")
{
    field(DESC, "Commanded angle(deg) for joint 5")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))J5CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:J5TweakVal")
{
    field(DESC, "Joint 5 tweak step size")
    field(EGU, "degrees")
}

record(bo, "$(P)$(R)Control:J5TweakFwd")
{
    field(DESC, "Tweak joint 5 forward")
    field(FLNK, "$(P)$(R)Control:J5TweakCalcFwd.PROC")
}

record(bo, "$(P)$(R)Control:J5TweakRev")
{
    field(DESC, "Tweak joint 5 backward")
    field(FLNK, "$(P)$(R)Control:J5TweakCalcRev.PROC")
}

record(calcout, "$(P)$(R)Control:J5TweakCalcFwd")
{
    field(INPA, "$(P)$(R)Control:J5Cmd")
    field(INPB, "$(P)$(R)Control:J5TweakVal")
    field(CALC, "A + B")
    field(OUT, "$(P)$(R)Control:J5Cmd PP")
}

record(calcout, "$(P)$(R)Control:J5TweakCalcRev")
{
    field(INPA, "$(P)$(R)Control:J5Cmd")
    field(INPB, "$(P)$(R)Control:J5TweakVal")
    field(CALC, "A - B")
    field(OUT, "$(P)$(R)Control:J5Cmd PP")
}
# -----------------------------------------------------------

record(ao, "$(P)$(R)Control:J6Cmd")
{
    field(DESC, "Commanded angle(deg) for joint 6")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))J6CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:J6TweakVal")
{
    field(DESC, "Joint 6 tweak step size")
    field(EGU, "degrees")
}

record(bo, "$(P)$(R)Control:J6TweakFwd")
{
    field(DESC, "Tweak joint 6 forward")
    field(FLNK, "$(P)$(R)Control:J6TweakCalcFwd.PROC")
}

record(bo, "$(P)$(R)Control:J6TweakRev")
{
    field(DESC, "Tweak joint 6 backward")
    field(FLNK, "$(P)$(R)Control:J6TweakCalcRev.PROC")
}

record(calcout, "$(P)$(R)Control:J6TweakCalcFwd")
{
    field(INPA, "$(P)$(R)Control:J6Cmd")
    field(INPB, "$(P)$(R)Control:J6TweakVal")
    field(CALC, "A + B")
    field(OUT, "$(P)$(R)Control:J6Cmd PP")
}

record(calcout, "$(P)$(R)Control:J6TweakCalcRev")
{
    field(INPA, "$(P)$(R)Control:J6Cmd")
    field(INPB, "$(P)$(R)Control:J6TweakVal")
    field(CALC, "A - B")
    field(OUT, "$(P)$(R)Control:J6Cmd PP")
}

#======================
# TCP pose control
#======================

record(bo, "$(P)$(R)Control:moveL")
{
    field(DESC, "Move to TCP pose linearly")
    field(DTYP, "asynInt32")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))MOVEL")
}

record(waveform, "$(P)$(R)Control:ActualTCPPose")
{
    field(DESC, "Actual TCP Pose")     
    field(DTYP, "asynFloat64ArrayIn")
    field(FTVL, "DOUBLE")
    field(INP,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))ACTUAL_TCP_POSE")
    field(NELM, 6)
    field(FLNK, "$(P)$(R)pose_index_fanout.PROC")
    field(SCAN, "I/O Intr")
}

record(fanout, "$(P)$(R)pose_index_fanout")
{
    field(LNK0, "$(P)$(R)Control:pose_index0")
    field(LNK1, "$(P)$(R)Control:pose_index1")
    field(LNK2, "$(P)$(R)Control:pose_index2")
    field(LNK3, "$(P)$(R)Control:pose_index3")
    field(LNK4, "$(P)$(R)Control:pose_index4")
    field(LNK5, "$(P)$(R)Control:pose_index5")
}

# subArray to extract each element of ActualTCPPose waveform
record(subArray, "$(P)$(R)Control:pose_index0")
{
    field(INP, "$(P)$(R)Control:ActualTCPPose.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "0")
}
record(subArray, "$(P)$(R)Control:pose_index1")
{
    field(INP, "$(P)$(R)Control:ActualTCPPose.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "1")
}
record(subArray, "$(P)$(R)Control:pose_index2")
{
    field(INP, "$(P)$(R)Control:ActualTCPPose.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "2")
}
record(subArray, "$(P)$(R)Control:pose_index3")
{
    field(INP, "$(P)$(R)Control:ActualTCPPose.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "3")
}
record(subArray, "$(P)$(R)Control:pose_index4")
{
    field(INP, "$(P)$(R)Control:ActualTCPPose.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "4")
}
record(subArray, "$(P)$(R)Control:pose_index5")
{
    field(INP, "$(P)$(R)Control:ActualTCPPose.VAL")
    field(FTVL, "DOUBLE")
    field(MALM, "6")
    field(NELM, "1")
    field(INDX, "5")
}

# stores DOLx.VAL in LNKx.VAL
# resets commanded TCP pose to the current measured pose
record(seq, "$(P)Control:ResetPoseCmd")
{
    field(DOL0, "$(P)$(R)Control:pose_index0")
    field(LNK0, "$(P)$(R)Control:PoseXCmd PP")

    field(DOL1, "$(P)$(R)Control:pose_index1")
    field(LNK1, "$(P)$(R)Control:PoseYCmd PP")

    field(DOL2, "$(P)$(R)Control:pose_index2")
    field(LNK2, "$(P)$(R)Control:PoseZCmd PP")

    field(DOL3, "$(P)$(R)Control:pose_index3")
    field(LNK3, "$(P)$(R)Control:PoseRollCmd PP")
    
    field(DOL4, "$(P)$(R)Control:pose_index4")
    field(LNK4, "$(P)$(R)Control:PosePitchCmd PP")

    field(DOL5, "$(P)$(R)Control:pose_index5")
    field(LNK5, "$(P)$(R)Control:PoseYawCmd PP")
}

record(ao, "$(P)$(R)Control:PoseXCmd")
{
    field(DESC, "Commanded TCP X")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))POSE_X_CMD")
    field(EGU, "mm")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:PoseYCmd")
{
    field(DESC, "Commanded TCP Y")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))POSE_Y_CMD")
    field(EGU, "mm")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:PoseZCmd")
{
    field(DESC, "Commanded TCP Z")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))POSE_Z_CMD")
    field(EGU, "mm")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:PoseRollCmd")
{
    field(DESC, "Commanded TCP roll")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))POSE_ROLL_CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:PosePitchCmd")
{
    field(DESC, "Commanded TCP pitch")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))POSE_PITCH_CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}

record(ao, "$(P)$(R)Control:PoseYawCmd")
{
    field(DESC, "Commanded TCP yaw")
    field(DTYP, "asynFloat64")
    field(OUT,  "@asyn($(PORT),$(ADDR),$(TIMEOUT=1))POSE_YAW_CMD")
    field(EGU, "degrees")
    field(PINI, 1)
    field(PREC, 4)
}
