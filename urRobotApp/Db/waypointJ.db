# This database defines a single waypoint for the robot in joint space
# including the gripper state where 0=open and 1=closed

record(stringout, "$(P)WaypointJ:$(N)")
{
    field(VAL, "$(DESC=)")
}

record(bo, "$(P)WaypointJ:$(N):Enabled")
{
    field(VAL, 0)
    field(ZNAM, "0")
    field(ONAM, "1")
}

record(bo, "$(P)WaypointJ:$(N):SetEnabled")
{
    field(VAL, 1)
    field(OUT, "$(P)WaypointJ:$(N):Enabled PP")
}

record(ao, "$(P)WaypointJ:$(N):J1")
{
    field(VAL, "$(J1=0)")
    field(PREC, 2)
    field(EGU, "deg")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(ao, "$(P)WaypointJ:$(N):J2")
{
    field(VAL, "$(J2=0)")
    field(PREC, 2)
    field(EGU, "deg")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(ao, "$(P)WaypointJ:$(N):J3")
{
    field(VAL, "$(J3=0)")
    field(PREC, 2)
    field(EGU, "deg")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(ao, "$(P)WaypointJ:$(N):J4")
{
    field(VAL, "$(J4=0)")
    field(PREC, 2)
    field(EGU, "deg")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(ao, "$(P)WaypointJ:$(N):J5")
{
    field(VAL, "$(J5=0)")
    field(PREC, 2)
    field(EGU, "deg")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(ao, "$(P)WaypointJ:$(N):J6")
{
    field(VAL, "$(J6=0)")
    field(PREC, 2)
    field(EGU, "deg")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

# record(bo, "$(P)WaypointJ:$(N):Gripper")
# {
    # field(ZNAM, "OPEN")
    # field(ONAM, "CLOSED")
    # field(VAL, "$(GRIPPER=0)")
    # field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
# }

record(ao, "$(P)WaypointJ:$(N):Speed")
{
    field(VAL, "$(SPEED=0.5)")
    field(PREC, 2)
    field(EGU, "rad/s")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(ao, "$(P)WaypointJ:$(N):Acceleration")
{
    field(VAL, "$(ACCEL=1.0)")
    field(PREC, 2)
    field(EGU, "rad/s/s")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(ao, "$(P)WaypointJ:$(N):Blend")
{
    field(VAL, "$(BLEND=0.0)")
    field(PREC, 2)
    field(EGU, "m")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(bo, "$(P)WaypointJ:$(N):Action")
{
    field(FLNK, "") # Action link set by user
    field(VAL, 1)
    field(OUT, "$(P)WaypointJ:$(N):set_not_done_seq.PROC")
}

# Action processing automatically sets ActionDone=0 to start
record(seq, "$(P)WaypointJ:$(N):set_not_done_seq")
{
    field(DOL0, "0")
    field(LNK0, "$(P)WaypointJ:$(N):ActionDone PP")
}

# set by user to define when action is done
# record(calcout, "$(P)WaypointJ:$(N):ActionDoneCalc")
# {
    # field(OUT, "$(P)WaypointJ:$(N):ActionDone PP")
    # field(SCAN, ".1 second") # needed if inputs not CP
# }

record(calcout, "$(P)WaypointJ:$(N):ActionDoneCalc")
{
    field(INPA, "") # set to selected action calc's .OUT by select func
    field(CALC, "A")
    field(OUT, "$(P)WaypointJ:$(N):ActionDone PP")
    # field(SCAN, ".1 second") # needed if inputs not CP
}

record(bo, "$(P)WaypointJ:$(N):ActionDone") 
{
    field(DESC, "1 if the action is done, otherwise 0")
    field(VAL, 1)
}

# Copies waypoint specific action stuff to global action PVs
# that can be used by RTDE Control driver
record(luascript, "$(P)WaypointJ:$(N):CopyActionLink")
{
    field(CODE, "@copy_action_link.lua copy_action_link({P='$(P)',R='',T='J',N='$(N)'})")
}

record(mbbi, "$(P)WaypointJ:$(N):ActionOpt")
{
    field(ONST, "Open gripper")
    field(TWST, "Close gripper")
    field(THST, "Action 3")
    field(FRST, "Action 4")
    field(FVST, "Action 5")
    field(SXST, "Action 6")
    field(SVST, "Action 7")
    field(EIST, "Action 8")
    field(NIST, "Action 9")
    field(TEST, "Action 10")
    field(FLNK, "$(P)WaypointJ:$(N):ActionOptSelect")
}

record(calcout, "$(P)WaypointJ:$(N):calc_trigger_select1")
{
    field(INPA, "$(P)ActionLink1.FLNK CP")
    field(INPB, "$(P)ActionLink2.FLNK CP")
    field(INPC, "$(P)ActionLink3.FLNK CP")
    field(INPD, "$(P)ActionLink4.FLNK CP")
    field(INPE, "$(P)ActionLink5.FLNK CP")
    field(INPF, "$(P)ActionLink6.FLNK CP")
    field(INPG, "$(P)ActionLink7.FLNK CP")
    field(INPH, "$(P)ActionLink8.FLNK CP")
    field(INPI, "$(P)ActionLink9.FLNK CP")
    field(INPJ, "$(P)ActionLink10.FLNK CP")
    field(FLNK, "$(P)WaypointJ:$(N):ActionOptSelect.PROC")
}

record(luascript, "$(P)WaypointJ:$(N):ActionOptSelect")
{
    field(INPA, "$(P)WaypointJ:$(N):ActionOpt")
    field(CODE, "@action_opt.lua select({P='$(P)',T='J',N='$(N)'})")
}

# record(luascript, "$(P)WaypointJ:$(N):get_action_descs")
# {
    # field(INAA, "$(P)ActionLink1.DESC CP")
    # field(INBB, "$(P)ActionLink2.DESC CP")
    # field(INCC, "$(P)ActionLink3.DESC CP")
    # field(INDD, "$(P)ActionLink4.DESC CP")
    # field(INEE, "$(P)ActionLink5.DESC CP")
    # field(INFF, "$(P)ActionLink6.DESC CP")
    # field(INGG, "$(P)ActionLink7.DESC CP")
    # field(INHH, "$(P)ActionLink8.DESC CP")
    # field(INII, "$(P)ActionLink9.DESC CP")
    # field(INJJ, "$(P)ActionLink10.DESC CP")
    # field(CODE, "@action_opt.lua update_option_names({P='$(P)',T='J',N='$(N)'})")
# }
# record(bo, "$(P)WaypointJ:$(N):updating_names_flag"){}

# 1 if robot is at waypoint within tolerance, otherwise 0
record(luascript, "$(P)WaypointJ:$(N):Reached") {
    field(INPA, "$(P)Receive:ActualJointPositions0 CP")
    field(INPB, "$(P)Receive:ActualJointPositions1 CP")
    field(INPC, "$(P)Receive:ActualJointPositions2 CP")
    field(INPD, "$(P)Receive:ActualJointPositions3 CP")
    field(INPE, "$(P)Receive:ActualJointPositions4 CP")
    field(INPF, "$(P)Receive:ActualJointPositions5 CP")
    field(CODE, "@waypoints.lua waypointJ_reached({prefix='$(P)', N=$(N), tol=$(TOL=0.1)})")
    field(PREC, 0)
    field(VAL, 0)
}

# stores DOLx.VAL in LNKx.VAL
# Requires that RTDE Receive databases have been loaded
record(seq, "$(P)WaypointJ:$(N):Reset")
{
    # Sets waypoint joint angles to the current measured angles
    field(DOL0, "$(P)Receive:ActualJointPositions0")
    field(LNK0, "$(P)WaypointJ:$(N):J1 PP")
    field(DOL1, "$(P)Receive:ActualJointPositions1")
    field(LNK1, "$(P)WaypointJ:$(N):J2 PP")
    field(DOL2, "$(P)Receive:ActualJointPositions2")
    field(LNK2, "$(P)WaypointJ:$(N):J3 PP")
    field(DOL3, "$(P)Receive:ActualJointPositions3")
    field(LNK3, "$(P)WaypointJ:$(N):J4 PP")
    field(DOL4, "$(P)Receive:ActualJointPositions4")
    field(LNK4, "$(P)WaypointJ:$(N):J5 PP")
    field(DOL5, "$(P)Receive:ActualJointPositions5")
    field(LNK5, "$(P)WaypointJ:$(N):J6 PP")
    field(FLNK, "$(P)WaypointJ:$(N):SetEnabled.PROC")
}

record(bo, "$(P)WaypointJ:$(N):moveJ")
{
    field(FLNK, "$(P)WaypointJ:$(N):moveJ_IfEnabled.PROC")
}

record(calcout, "$(P)WaypointJ:$(N):moveJ_IfEnabled")
{
    field(INPA, "$(P)WaypointJ:$(N):Enabled")
    field(OOPT, "When Non-zero")
    field(CALC, "A")
    field(OUT,"$(P)WaypointJ:$(N):moveJ_seq1.PROC")
}

record(seq, "$(P)WaypointJ:$(N):moveJ_seq1")
{
    # Disable AutoMoveJ
    field(DOL0, "0")
    field(LNK0, "$(P)Control:AutoMoveJ PP")

    # Set Control:JxCmd to WaypointJ:$(N):Jx
    field(DOL1, "$(P)WaypointJ:$(N):J1")
    field(LNK1, "$(P)Control:J1Cmd PP")
    field(DOL2, "$(P)WaypointJ:$(N):J2")
    field(LNK2, "$(P)Control:J2Cmd PP")
    field(DOL3, "$(P)WaypointJ:$(N):J3")
    field(LNK3, "$(P)Control:J3Cmd PP")
    field(DOL4, "$(P)WaypointJ:$(N):J4")
    field(LNK4, "$(P)Control:J4Cmd PP")
    field(DOL5, "$(P)WaypointJ:$(N):J5")
    field(LNK5, "$(P)Control:J5Cmd PP")
    field(DOL6, "$(P)WaypointJ:$(N):J6")
    field(LNK6, "$(P)Control:J6Cmd PP")
    
    field(FLNK, "$(P)WaypointJ:$(N):moveJ_seq2.PROC")
}

record(seq, "$(P)WaypointJ:$(N):moveJ_seq2")
{
    # Set to asynchronous motion
    field(DOL0, "1")
    field(LNK0, "$(P)Control:Asynchronous")
    
    # set speed, accel, blend, gripper action
    field(DOL1, "$(P)WaypointJ:$(N):Speed")
    field(LNK1, "$(P)Control:JointSpeed PP")
    field(DOL2, "$(P)WaypointJ:$(N):Acceleration")
    field(LNK2, "$(P)Control:JointAcceleration PP")
    field(DOL3, "$(P)WaypointJ:$(N):Blend")
    field(LNK3, "$(P)Control:JointBlend PP")
    field(DOL4, "1")
    field(LNK4, "$(P)WaypointJ:$(N):CopyActionLink.PROC")
    
    # Do the move
    field(FLNK, "$(P)Control:waypoint_moveJ.PROC")
}
